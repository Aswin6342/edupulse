{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>💬 Student Messages</h2>
  <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">← Back to Dashboard</a>
</div>

{% if messages %}
  <div class="card shadow">
    <div class="card-header">
      <h5>📨 Chat with Students</h5>
    </div>

    <div class="card-body d-flex flex-column" style="height: 75vh;">
      <!-- Chat area -->
      <div id="chat-box" class="flex-grow-1 p-3 border rounded bg-light overflow-auto mb-3">
        {% for message in messages %}
          <!-- Student Question -->
          <div class="d-flex mb-2">
            <div class="p-2 px-3 bg-white text-dark rounded-3 shadow-sm" 
                 style="max-width: 70%; border-bottom-left-radius: 0.5rem;">
              <strong class="d-block text-primary">{{ message.student.username }}</strong>
              <p class="mb-1">{{ message.question }}</p>
              <small class="text-muted">{{ message.created_at|date:"M d, Y H:i" }}</small>
            </div>
          </div>

          <!-- Mentor Reply -->
          {% if message.reply %}
            <div class="d-flex justify-content-end mb-2">
              <div class="p-2 px-3 bg-success text-white rounded-3 shadow-sm text-end" 
                   style="max-width: 70%; border-bottom-right-radius: 0.5rem;">
                <strong class="d-block">You</strong>
                <p class="mb-1">{{ message.reply }}</p>
                <small class="text-white-50">{{ message.created_at|date:"M d, Y H:i" }}</small>
              </div>
            </div>
          {% else %}
            <!-- Reply Form -->
            <form method="post" class="d-flex mt-2">
              {% csrf_token %}
              <input type="hidden" name="msg_id" value="{{ message.id }}">
              <textarea name="reply" class="form-control me-2" rows="1" placeholder="Type your reply..." required></textarea>
              <button type="submit" class="btn btn-success">Send</button>
            </form>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Auto-scroll to bottom -->
  <script>
    var chatBox = document.getElementById("chat-box");
    if (chatBox) {
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>

{% else %}
  <div class="text-center py-5">
    <h4 class="text-muted">No messages from students yet.</h4>
    <p>Students will appear here when they send you questions.</p>
  </div>
{% endif %}
{% endblock %}
